<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoFill Vision - Document Scanner</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root { --bg-primary: #0f0f1a; --bg-secondary: #1a1a2e; --bg-card: rgba(255,255,255,0.03); --accent: #6366f1; --accent-glow: rgba(99, 102, 241, 0.3); --success: #10b981; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --border: rgba(255,255,255,0.08); }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg-primary); min-height: 100vh; color: var(--text-primary); }
        .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border); padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .logo { display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent), #8b5cf6); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }
        .logo-text { font-weight: 600; font-size: 1.25rem; }
        .logo-text span { color: var(--accent); }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem; }
        @media (max-width: 1024px) { .main-grid { grid-template-columns: 1fr; } }
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; backdrop-filter: blur(10px); }
        .card-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .card-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent), #8b5cf6); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .card-title { font-weight: 600; font-size: 1.1rem; }
        .upload-zone { border: 2px dashed var(--border); border-radius: 12px; padding: 3rem 2rem; text-align: center; cursor: pointer; transition: all 0.3s; }
        .upload-zone:hover { border-color: var(--accent); background: rgba(99, 102, 241, 0.05); }
        .upload-zone.has-file { border-color: var(--success); border-style: solid; }
        .upload-zone input { display: none; }
        .upload-icon { font-size: 3rem; margin-bottom: 1rem; display: block; }
        .upload-text { color: var(--text-secondary); margin-bottom: 0.5rem; }
        .upload-hint { font-size: 0.85rem; color: var(--text-secondary); opacity: 0.7; }
        .preview-img { max-width: 100%; max-height: 300px; border-radius: 8px; display: none; margin-top: 1rem; }
        .preview-img.visible { display: block; }
        .progress-container { margin-top: 1.5rem; display: none; }
        .progress-container.visible { display: block; }
        .progress-bar { height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #8b5cf6); width: 0%; transition: width 0.3s; }
        .progress-text { margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary); text-align: center; }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        @media (max-width: 640px) { .form-grid { grid-template-columns: 1fr; } }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-label { font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); display: flex; align-items: center; gap: 0.5rem; }
        .form-label .extracted { background: var(--success); color: white; font-size: 0.65rem; padding: 0.15rem 0.4rem; border-radius: 4px; }
        .form-input { background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.95rem; transition: all 0.2s; }
        .form-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .form-input.auto-filled { border-color: var(--success); background: rgba(16, 185, 129, 0.1); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer; border: none; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
        .btn-primary { background: linear-gradient(135deg, var(--accent), #8b5cf6); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 20px var(--accent-glow); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-primary); }
        .btn-success { background: linear-gradient(135deg, var(--success), #059669); color: white; }
        .btn-group { display: flex; gap: 0.75rem; margin-top: 1.5rem; flex-wrap: wrap; }
        .extracted-panel { background: var(--bg-secondary); border-radius: 8px; padding: 1rem; margin-top: 1rem; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; display: none; }
        .extracted-panel.visible { display: block; }
        .extracted-panel .line { color: var(--text-secondary); border-bottom: 1px solid var(--border); padding: 0.25rem 0; }
        .toast { position: fixed; bottom: 2rem; right: 2rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 1rem 1.5rem; display: flex; align-items: center; gap: 0.75rem; transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 2000; }
        .toast.visible { transform: translateY(0); opacity: 1; }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: #ef4444; }
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-box { background: var(--bg-secondary); border-radius: 8px; padding: 1rem; text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--accent); }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .doc-type { display: none; align-items: center; gap: 0.5rem; background: var(--bg-secondary); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; margin-top: 1rem; }
        .doc-type.visible { display: inline-flex; }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo"><div class="logo-icon">üìÑ</div><div class="logo-text">Auto<span>Fill</span> Vision</div></div>
    </header>
    <div class="container">
        <div class="main-grid">
            <div class="card">
                <div class="card-header"><div class="card-icon">üì§</div><div class="card-title">Subir Documento</div></div>
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept="image/*,.pdf" onchange="handleFileSelect(event)">
                    <span class="upload-icon">üîç</span>
                    <p class="upload-text">Arrastra tu documento aqu√≠ o haz clic</p>
                    <p class="upload-hint">INE, Pasaporte, RFC, Comprobante, General Info, etc.</p>
                </div>
                <img id="previewImg" class="preview-img">
                <div id="docType" class="doc-type"><span>üìã</span><span id="docTypeText">Detectando...</span></div>
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                    <p class="progress-text" id="progressText">Procesando...</p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" id="scanBtn" onclick="scanDocument()" disabled>üîç Escanear con Vision</button>
                    <button class="btn btn-secondary" onclick="clearAll()">üóëÔ∏è Limpiar</button>
                </div>
                <div class="extracted-panel" id="extractedPanel"><div id="extractedText"></div></div>
            </div>
            <div class="card">
                <div class="card-header"><div class="card-icon">‚úèÔ∏è</div><div class="card-title">Datos Extra√≠dos</div></div>
                <div class="stats-row">
                    <div class="stat-box"><div class="stat-value" id="statFields">0</div><div class="stat-label">Campos</div></div>
                    <div class="stat-box"><div class="stat-value" id="statFilled">0</div><div class="stat-label">Llenados</div></div>
                    <div class="stat-box"><div class="stat-value" id="statConfidence">-</div><div class="stat-label">Confianza</div></div>
                </div>
                <div class="form-grid" id="formGrid">
                    <div class="form-group"><label class="form-label">Nombre / Name</label><input type="text" class="form-input" id="fieldNombre"></div>
                    <div class="form-group"><label class="form-label">Fecha Nac. / DOB</label><input type="text" class="form-input" id="fieldFechaNac"></div>
                    <div class="form-group"><label class="form-label">CURP</label><input type="text" class="form-input" id="fieldCURP" maxlength="18"></div>
                    <div class="form-group"><label class="form-label">RFC</label><input type="text" class="form-input" id="fieldRFC" maxlength="13"></div>
                    <div class="form-group"><label class="form-label">Pasaporte / Passport</label><input type="text" class="form-input" id="fieldPasaporte"></div>
                    <div class="form-group"><label class="form-label">Nacionalidad / Nationality</label><input type="text" class="form-input" id="fieldNacionalidad"></div>
                    <div class="form-group full-width"><label class="form-label">Domicilio M√©xico</label><input type="text" class="form-input" id="fieldDomicilioMX"></div>
                    <div class="form-group full-width"><label class="form-label">Address Abroad</label><input type="text" class="form-input" id="fieldDomicilioExt"></div>
                    <div class="form-group"><label class="form-label">Estado Civil / Marital</label><input type="text" class="form-input" id="fieldEstadoCivil"></div>
                    <div class="form-group"><label class="form-label">Ocupaci√≥n / Occupation</label><input type="text" class="form-input" id="fieldOcupacion"></div>
                    <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="fieldEmail"></div>
                    <div class="form-group"><label class="form-label">Tel√©fono / Phone</label><input type="tel" class="form-input" id="fieldTel"></div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="exportData()">üì• Exportar JSON</button>
                    <button class="btn btn-secondary" onclick="copyToClipboard()">üìã Copiar</button>
                </div>
            </div>
        </div>
    </div>
    <div class="toast" id="toast"><span id="toastIcon">‚úÖ</span><span id="toastMessage">Mensaje</span></div>

    <script>
        const state = { file: null, imageBase64: null, extractedText: '' };
        const uploadZone = document.getElementById('uploadZone');
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); });
        uploadZone.addEventListener('drop', (e) => { e.preventDefault(); if(e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]); });
        function handleFileSelect(event) { if(event.target.files[0]) processFile(event.target.files[0]); }
        function processFile(file) {
            state.file = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                state.imageBase64 = e.target.result.split(',')[1];
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('previewImg').classList.add('visible');
                uploadZone.classList.add('has-file');
                document.getElementById('scanBtn').disabled = false;
                document.getElementById('docType').classList.add('visible');
                document.getElementById('docTypeText').textContent = 'Documento listo';
            };
            reader.readAsDataURL(file);
            showToast('Documento cargado', 'success');
        }
        async function scanDocument() {
            if (!state.imageBase64) { showToast('Sube un documento primero', 'error'); return; }
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            progressContainer.classList.add('visible');
            progressFill.style.width = '20%';
            progressText.textContent = 'Conectando con Google Vision...';
            try {
                progressFill.style.width = '40%';
                progressText.textContent = 'Analizando documento...';
                const response = await fetch('/api/vision', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: state.imageBase64 })
                });
                const data = await response.json();
                console.log('API Response:', data);
                if (data.error) throw new Error(data.error);
                if (!data.responses || !data.responses[0]) throw new Error('Respuesta vac√≠a de Vision API');
                const textAnnotations = data.responses[0].textAnnotations;
                const fullText = data.responses[0].fullTextAnnotation;
                let extractedText = '';
                if (fullText && fullText.text) {
                    extractedText = fullText.text;
                } else if (textAnnotations && textAnnotations.length > 0) {
                    extractedText = textAnnotations[0].description;
                }
                if (!extractedText) throw new Error('No se detect√≥ texto en el documento');
                state.extractedText = extractedText;
                progressFill.style.width = '90%';
                progressText.textContent = 'Extrayendo datos...';
                showExtractedText(extractedText);
                parseAndFillForm(extractedText);
                progressFill.style.width = '100%';
                progressText.textContent = '¬°Completado!';
                setTimeout(() => { progressContainer.classList.remove('visible'); }, 2000);
                showToast('Documento escaneado exitosamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                progressContainer.classList.remove('visible');
                showToast('Error: ' + error.message, 'error');
            }
        }
        function showExtractedText(text) {
            const panel = document.getElementById('extractedPanel');
            const textContainer = document.getElementById('extractedText');
            textContainer.innerHTML = text.split('\n').filter(l => l.trim()).map(l => `<div class="line">${l}</div>`).join('');
            panel.classList.add('visible');
        }
        function parseAndFillForm(text) {
            let filledCount = 0;
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            // Helper to find value after label
            function findValue(patterns) {
                for (const line of lines) {
                    for (const pattern of patterns) {
                        const regex = new RegExp(pattern + '[:\\s]+(.+)', 'i');
                        const match = line.match(regex);
                        if (match) return match[1].trim();
                    }
                }
                return null;
            }
            // Name
            const name = findValue(['Name', 'Nombre', 'Nombre Completo']);
            if (name) { fillField('fieldNombre', name); filledCount++; }
            // Date of Birth
            const dob = findValue(['Date of Birth', 'Fecha de Nacimiento', 'Fecha Nac', 'DOB']);
            if (dob) { fillField('fieldFechaNac', dob); filledCount++; }
            // Passport
            const passport = findValue(['Passport', 'Pasaporte', 'Passport Number']);
            if (passport) { fillField('fieldPasaporte', passport.split(/\s+/)[0]); filledCount++; }
            // Nationality
            const nationality = findValue(['Nationality', 'Nacionalidad']);
            if (nationality) { fillField('fieldNacionalidad', nationality); filledCount++; }
            // Marital Status
            const marital = findValue(['Marital Status', 'Estado Civil', 'Marital']);
            if (marital) { fillField('fieldEstadoCivil', marital); filledCount++; }
            // Address Mexico
            const addrMX = findValue(['Address in Mexico', 'Domicilio en Mexico', 'Direccion Mexico', 'Domicilio']);
            if (addrMX) { fillField('fieldDomicilioMX', addrMX); filledCount++; }
            // Address Abroad
            const addrAbroad = findValue(['Address Abroad', 'Direccion Extranjero', 'Domicilio Extranjero', 'Address in']);
            if (addrAbroad) { fillField('fieldDomicilioExt', addrAbroad); filledCount++; }
            // Occupation
            const occupation = findValue(['Occupation', 'Ocupacion', 'Profesion']);
            if (occupation) { fillField('fieldOcupacion', occupation); filledCount++; }
            // CURP
            const curpMatch = text.match(/[A-Z]{4}\d{6}[HM][A-Z]{5}[A-Z\d]\d/);
            if (curpMatch) { fillField('fieldCURP', curpMatch[0]); filledCount++; }
            // RFC
            const rfcMatch = text.match(/[A-Z&√ë]{3,4}\d{6}[A-Z0-9]{3}/);
            if (rfcMatch) { fillField('fieldRFC', rfcMatch[0]); filledCount++; }
            // Email
            const emailMatch = text.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);
            if (emailMatch) { fillField('fieldEmail', emailMatch[0]); filledCount++; }
            // Phone
            const telMatch = text.match(/\b\d{10}\b/);
            if (telMatch) { fillField('fieldTel', telMatch[0]); filledCount++; }
            updateStats(filledCount);
        }
        function fillField(id, value) {
            const field = document.getElementById(id);
            if (field && value) {
                field.value = value;
                field.classList.add('auto-filled');
                const label = field.parentElement.querySelector('.form-label');
                if (label && !label.querySelector('.extracted')) {
                    const badge = document.createElement('span');
                    badge.className = 'extracted';
                    badge.textContent = 'AUTO';
                    label.appendChild(badge);
                }
            }
        }
        function updateStats(filled) {
            const total = document.querySelectorAll('.form-input').length;
            document.getElementById('statFields').textContent = total;
            document.getElementById('statFilled').textContent = filled;
            document.getElementById('statConfidence').textContent = Math.round((filled / total) * 100) + '%';
        }
        function exportData() {
            const data = {};
            document.querySelectorAll('.form-input').forEach(input => { data[input.id.replace('field', '')] = input.value; });
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'datos_' + Date.now() + '.json'; a.click();
            showToast('Exportado', 'success');
        }
        function copyToClipboard() {
            const data = {};
            document.querySelectorAll('.form-input').forEach(input => { data[input.id.replace('field', '')] = input.value; });
            navigator.clipboard.writeText(JSON.stringify(data, null, 2));
            showToast('Copiado', 'success');
        }
        function clearAll() {
            state.file = null; state.imageBase64 = null; state.extractedText = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('previewImg').classList.remove('visible');
            uploadZone.classList.remove('has-file');
            document.getElementById('scanBtn').disabled = true;
            document.getElementById('docType').classList.remove('visible');
            document.getElementById('extractedPanel').classList.remove('visible');
            document.getElementById('progressContainer').classList.remove('visible');
            document.querySelectorAll('.form-input').forEach(input => { input.value = ''; input.classList.remove('auto-filled'); });
            document.querySelectorAll('.extracted').forEach(b => b.remove());
            updateStats(0);
        }
        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            document.getElementById('toastIcon').textContent = type === 'success' ? '‚úÖ' : '‚ùå';
            document.getElementById('toastMessage').textContent = msg;
            toast.className = 'toast visible ' + type;
            setTimeout(() => toast.classList.remove('visible'), 3000);
        }
        updateStats(0);
    </script>
</body>
</html>
